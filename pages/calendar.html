<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="NexusAI Calendar - 行事曆">
  <meta name="theme-color" content="#FFFFFF">

  <title>行事曆 - NexusAI</title>

  <!-- Head Loader（集中管理核心 CSS/Fonts/版本號） -->
  <script src="../js/head-loader.js"></script>
</head>
<body>
  <!-- Skip Link (無障礙) -->
  <a href="#main-content" class="skip-link">跳至主要內容</a>

  <!-- Sidebar Layout -->
  <div class="sidebar-layout">
    <!-- Sidebar Container -->
    <nav id="sidebar-container" class="sidebar-layout__sidebar" aria-label="側邊導航"></nav>

    <!-- Main Content -->
    <main id="main-content" class="sidebar-layout__main">
      <!-- Page Header -->
      <div class="page-header mb-8">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="h3" data-lang="page.calendar">行事曆</h1>
            <p class="text-secondary mt-2" data-lang="calendar.subtitle">管理您的日程安排與重要事件。</p>
          </div>
          <div class="flex items-center gap-3">
            <!-- Add Event Button -->
            <button class="btn btn--primary" data-add-event>
              <i data-lucide="plus"></i>
              <span data-lang="calendar.addEvent">新增事件</span>
            </button>
            <!-- Language Toggle -->
            <button class="btn btn--secondary btn--sm" data-lang-toggle aria-label="切換語言">
              <span data-lang-display>中</span>
            </button>
            <!-- Theme Toggle -->
            <button class="btn btn--secondary btn--sm" data-theme-toggle aria-label="切換主題">
              <i data-lucide="moon" data-theme-icon></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Calendar Controls -->
      <section class="mb-6">
        <div class="glass-card p-4">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <!-- Month Navigation -->
            <div class="flex items-center gap-3">
              <button class="btn btn--secondary" data-prev-month aria-label="上個月" data-lang-aria="calendar.nav.prevMonth">
                <i data-lucide="chevron-left"></i>
              </button>
              <h2 class="h5" data-current-month>2025 年 12 月</h2>
              <button class="btn btn--secondary" data-next-month aria-label="下個月" data-lang-aria="calendar.nav.nextMonth">
                <i data-lucide="chevron-right"></i>
              </button>
            </div>

            <!-- View Toggle -->
            <div class="flex gap-2">
              <button class="btn btn--secondary btn--sm active" data-view="month" data-lang="calendar.month">月</button>
              <button class="btn btn--secondary btn--sm" data-view="week" data-lang="calendar.week">週</button>
              <button class="btn btn--secondary btn--sm" data-view="day" data-lang="calendar.day">日</button>
            </div>

            <!-- Today Button -->
            <button class="btn btn--secondary" data-today>
              <i data-lucide="calendar"></i>
              <span data-lang="calendar.today">今天</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Calendar Grid -->
      <section>
        <div class="glass-card p-6">
          <!-- Weekday Headers -->
          <div class="calendar-grid">
            <div class="calendar-header" data-lang="calendar.weekday.sun">日</div>
            <div class="calendar-header" data-lang="calendar.weekday.mon">一</div>
            <div class="calendar-header" data-lang="calendar.weekday.tue">二</div>
            <div class="calendar-header" data-lang="calendar.weekday.wed">三</div>
            <div class="calendar-header" data-lang="calendar.weekday.thu">四</div>
            <div class="calendar-header" data-lang="calendar.weekday.fri">五</div>
            <div class="calendar-header" data-lang="calendar.weekday.sat">六</div>
          </div>

          <!-- Calendar Days -->
          <div class="calendar-grid" id="calendar-days">
            <!-- Day cells will be generated by JavaScript -->
          </div>
        </div>
      </section>

      <!-- Upcoming Events -->
      <section class="mt-8">
        <div class="glass-card">
          <div class="card__header flex items-center justify-between">
            <h3 class="h5" data-lang="calendar.upcoming.title">即將到來的事件</h3>
            <a href="#" class="text-brand text-sm" data-lang="btn.viewAll">查看全部</a>
          </div>
          <div class="card__body p-0">
            <div class="event-list">

              <!-- Event Item 1 -->
              <div class="event-item">
                <div class="event-item__date">
                  <div class="event-date-badge">
                    <div class="event-date-badge__day">18</div>
                    <div class="event-date-badge__month" data-lang="calendar.month.dec">12月</div>
                  </div>
                </div>
                <div class="event-item__content">
                  <h4 class="event-item__title" data-lang="calendar.event.teamWeekly">團隊週會</h4>
                  <p class="event-item__time">
                    <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                    10:00 - 11:00
                  </p>
                  <p class="event-item__location">
                    <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                    <span data-lang="calendar.location.meetingRoomA">會議室 A</span>
                  </p>
                </div>
                <div class="event-item__attendees">
                  <div class="flex -space-x-2">
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">J</div>
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-secondary), var(--color-success)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">A</div>
                    <div class="avatar avatar--sm" style="background: rgba(168, 85, 247, 0.2); display: flex; align-items: center; justify-content: center; color: var(--color-primary); font-weight: 600; border: 2px solid white; font-size: 12px;">+5</div>
                  </div>
                </div>
              </div>

              <!-- Event Item 2 -->
              <div class="event-item">
                <div class="event-item__date">
                  <div class="event-date-badge" style="background: rgba(6, 182, 212, 0.1); border-color: var(--color-secondary);">
                    <div class="event-date-badge__day" style="color: var(--color-secondary);">20</div>
                    <div class="event-date-badge__month" style="color: var(--color-secondary);" data-lang="calendar.month.dec">12月</div>
                  </div>
                </div>
                <div class="event-item__content">
                  <h4 class="event-item__title" data-lang="calendar.event.designReview">產品設計評審</h4>
                  <p class="event-item__time">
                    <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                    14:00 - 16:00
                  </p>
                  <p class="event-item__location">
                    <i data-lucide="video" style="width: 14px; height: 14px;"></i>
                    <span data-lang="calendar.location.online">線上會議</span>
                  </p>
                </div>
                <div class="event-item__attendees">
                  <div class="flex -space-x-2">
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-success), var(--color-primary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">B</div>
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-warning), var(--color-error)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">C</div>
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-error), var(--color-warning)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">D</div>
                  </div>
                </div>
              </div>

              <!-- Event Item 3 -->
              <div class="event-item">
                <div class="event-item__date">
                  <div class="event-date-badge" style="background: rgba(34, 197, 94, 0.1); border-color: var(--color-success);">
                    <div class="event-date-badge__day" style="color: var(--color-success);">23</div>
                    <div class="event-date-badge__month" style="color: var(--color-success);" data-lang="calendar.month.dec">12月</div>
                  </div>
                </div>
                <div class="event-item__content">
                  <h4 class="event-item__title" data-lang="calendar.event.milestoneReview">專案里程碑檢討</h4>
                  <p class="event-item__time">
                    <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                    09:00 - 12:00
                  </p>
                  <p class="event-item__location">
                    <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                    <span data-lang="calendar.location.hqMainMeeting">總部大會議室</span>
                  </p>
                </div>
                <div class="event-item__attendees">
                  <div class="flex -space-x-2">
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">E</div>
                    <div class="avatar avatar--sm" style="background: linear-gradient(135deg, var(--color-secondary), var(--color-success)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; border: 2px solid white;">F</div>
                    <div class="avatar avatar--sm" style="background: rgba(168, 85, 247, 0.2); display: flex; align-items: center; justify-content: center; color: var(--color-primary); font-weight: 600; border: 2px solid white; font-size: 12px;">+8</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Main JavaScript -->
  <script type="module">
    import { initTheme } from '../js/theme.js';
    import { initI18n, getCurrentLanguage, t } from '../js/i18n.js';
    import { render as renderSidebar } from '../js/components/sidebar.js';

    // 初始化
    document.addEventListener('DOMContentLoaded', async () => {
      // 初始化主題系統
      initTheme();

      // 初始化語言系統
      initI18n();

      // 載入側邊欄
      const sidebarContainer = document.getElementById('sidebar-container');
      if (sidebarContainer) {
        renderSidebar(sidebarContainer);
      }

      // 初始化 Lucide Icons
      const { initIcons } = await import('../js/lucide-icons.js');
      await initIcons();

      // 初始化行事曆
      initCalendar();
    });

    function initCalendar() {
      const currentDate = new Date();
      let currentMonth = currentDate.getMonth();
      let currentYear = currentDate.getFullYear();

      // 模擬事件資料
      const events = {
        '2025-12-18': [{ titleKey: 'calendar.event.teamWeekly', color: 'var(--color-primary)' }],
        '2025-12-20': [{ titleKey: 'calendar.event.designReview', color: 'var(--color-secondary)' }],
        '2025-12-23': [{ titleKey: 'calendar.event.milestoneReview', color: 'var(--color-success)' }],
        '2025-12-25': [{ titleKey: 'calendar.event.christmas', color: 'var(--color-error)' }],
      };

      function formatMonthTitle(year, monthIndex) {
        const isEn = getCurrentLanguage() === 'en';
        if (!isEn) return `${year} 年 ${monthIndex + 1} 月`;
        return new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long' }).format(new Date(year, monthIndex, 1));
      }

      function renderCalendar() {
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const calendarDays = document.getElementById('calendar-days');
        const monthHeader = document.querySelector('[data-current-month]');

        // 更新月份標題
        monthHeader.textContent = formatMonthTitle(currentYear, currentMonth);

        // 清空日曆
        calendarDays.innerHTML = '';

        // 填充前面的空白日期（上個月）
        const prevMonthDays = new Date(currentYear, currentMonth, 0).getDate();
        for (let i = firstDay - 1; i >= 0; i--) {
          const dayCell = createDayCell(prevMonthDays - i, true);
          calendarDays.appendChild(dayCell);
        }

        // 填充當月日期
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const isToday = day === currentDate.getDate() &&
                         currentMonth === currentDate.getMonth() &&
                         currentYear === currentDate.getFullYear();
          const dayEvents = events[dateStr] || [];
          const dayCell = createDayCell(day, false, isToday, dayEvents);
          calendarDays.appendChild(dayCell);
        }

        // 填充後面的空白日期（下個月）
        const totalCells = calendarDays.children.length;
        const remainingCells = 42 - totalCells; // 6 rows * 7 days
        for (let i = 1; i <= remainingCells; i++) {
          const dayCell = createDayCell(i, true);
          calendarDays.appendChild(dayCell);
        }
      }

      function createDayCell(day, isOtherMonth, isToday = false, events = []) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        if (isOtherMonth) cell.classList.add('calendar-day--other-month');
        if (isToday) cell.classList.add('calendar-day--today');
        if (events.length > 0) cell.classList.add('calendar-day--has-event');

        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day__number';
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        // 添加事件標記
        if (events.length > 0) {
          const eventDots = document.createElement('div');
          eventDots.className = 'calendar-day__events';
          events.forEach((event) => {
            const dot = document.createElement('div');
            dot.className = 'event-dot';
            dot.style.background = event.color;
            dot.title = t(event.titleKey);
            eventDots.appendChild(dot);
          });
          cell.appendChild(eventDots);
        }

        return cell;
      }

      // 初始渲染
      renderCalendar();

      // 上個月按鈕
      document.querySelector('[data-prev-month]')?.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        renderCalendar();
      });

      // 下個月按鈕
      document.querySelector('[data-next-month]')?.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar();
      });

      // 今天按鈕
      document.querySelector('[data-today]')?.addEventListener('click', () => {
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
        renderCalendar();
      });

      // 新增事件按鈕
      document.querySelector('[data-add-event]')?.addEventListener('click', () => {
        alert(t('calendar.alert.addEventWip'));
      });

      // 視圖切換
      const viewButtons = document.querySelectorAll('[data-view]');
      viewButtons.forEach(button => {
        button.addEventListener('click', () => {
          viewButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          // 視圖切換邏輯（待實作）
        });
      });

      // 語言切換後：重繪月份標題與事件 tooltip
      window.addEventListener('languagechange', () => {
        renderCalendar();
      });
    }
  </script>

  <style>
    /* 頁面特定樣式 */
    .page-header {
      padding-bottom: var(--space-6);
      border-bottom: 1px solid var(--border-default);
    }

    /* Calendar Grid */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border-default);
    }

    .calendar-header {
      background: var(--bg-secondary);
      padding: var(--space-3);
      text-align: center;
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .calendar-day {
      background: var(--bg-primary);
      min-height: 100px;
      padding: var(--space-2);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .calendar-day:hover {
      background: var(--bg-secondary);
    }

    .calendar-day--other-month {
      opacity: 0.3;
    }

    .calendar-day--today {
      background: rgba(168, 85, 247, 0.1);
    }

    .calendar-day--today .calendar-day__number {
      background: var(--color-primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .calendar-day__number {
      font-size: var(--text-sm);
      font-weight: 500;
      margin-bottom: var(--space-2);
    }

    .calendar-day__events {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .event-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    /* Event List */
    .event-list {
      padding: var(--space-4);
    }

    .event-item {
      display: flex;
      gap: var(--space-4);
      padding: var(--space-4);
      border-bottom: 1px solid var(--border-default);
      transition: background 0.2s ease;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-item:hover {
      background: var(--bg-secondary);
    }

    .event-date-badge {
      background: rgba(168, 85, 247, 0.1);
      border: 2px solid var(--color-primary);
      border-radius: 12px;
      padding: var(--space-2) var(--space-3);
      text-align: center;
      min-width: 60px;
    }

    .event-date-badge__day {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1;
    }

    .event-date-badge__month {
      font-size: var(--text-xs);
      color: var(--color-primary);
      margin-top: 2px;
    }

    .event-item__content {
      flex: 1;
    }

    .event-item__title {
      font-size: var(--text-base);
      font-weight: 600;
      margin-bottom: var(--space-2);
    }

    .event-item__time,
    .event-item__location {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-1);
    }

    .event-item__attendees {
      display: flex;
      align-items: center;
    }

    /* 響應式調整 */
    @media (max-width: 768px) {
      .calendar-day {
        min-height: 80px;
      }

      .event-item {
        flex-direction: column;
      }

      .event-date-badge {
        width: fit-content;
      }
    }
  </style>
</body>
</html>
